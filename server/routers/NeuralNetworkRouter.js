const express = require('express');
const app = express();

app.use(express.json());

app.get('/train', async(req, res) => {

  const datosCodificados = req.query.data;
  const datosJSON = decodeURIComponent(datosCodificados);
  //const datos = JSON.parse(datosJSON);


 
  const AlgoTensor3 = require('../../AlgoTensor3');

  const tensor = new AlgoTensor3();

  const trainingOptions = {
    rate: 0.001,
    iterations: 5000,
    error: 0.005,
  };

  const Calculador = require('../../Calculador');
  const algoritmo = new Calculador();

/*
    const datos = [
      { timestamp: 0, acc_x: 14.460978507995600, acc_y: 63302693367004300, acc_z: 719936466217041, gyro_x: -13377949595451300, gyro_y: -3219259977340690, gyro_z: -4043927788734430 },
      { timestamp: 1, acc_x: 10749965906143100, acc_y: 5705382823944090, acc_z: 7405265808105460, gyro_x: -15515977144241300, gyro_y: -24434609711170100, gyro_z: -455705463886261 },
      { timestamp: 1, acc_x: 6129156351089470, acc_y: 32609026432037300, acc_z: 51116204261779700, gyro_x: -22540926933288500, gyro_y: 8869763612747190, gyro_z: -1918116807937620 },
      { timestamp: 1, acc_x: 24013843536376900, acc_y: 1680729627609250, acc_z: 49799394607543900, gyro_x: -8124507665634150, gyro_y: -15460999011993400, gyro_z: -9132435321807860 },
      { timestamp: 2, acc_x: 14662091255187900, acc_y: -5669469833374020, acc_z: 7122750282287590, gyro_x: -13213015794754000, gyro_y: -3050661087036130, gyro_z: -1441641926765440 },
      { timestamp: 2, acc_x: 10342951774597100, acc_y: 7972691655158990, acc_z: 4525041103363030, gyro_x: -36022722721099800, gyro_y: -17776178121566700, gyro_z: 2219273328781120 },
      { timestamp: 2, acc_x: 16184803009033200, acc_y: -4606443881988520, acc_z: 5181052684783930, gyro_x: -7312057018280020, gyro_y: 2528982162475580, gyro_z: 19792033731937400 },
      { timestamp: 3, acc_x: 3957615375518790, acc_y: -5394136428833000, acc_z: -18148049116134600, gyro_x: 3504534006118770, gyro_y: 6615670323371880, gyro_z: -2192395448684690 },
      { timestamp: 3, acc_x: -13096283674240100, acc_y: 2736572504043570, acc_z: 6550535678863520, gyro_x: -2822197377681730, gyro_y: -4428772926330560, gyro_z: -4349360466003410 },
      { timestamp: 3, acc_x: 5216965675354000, acc_y: -4491522312164300, acc_z: -11659762859344400, gyro_x: 8112290501594540, gyro_y: -6475171446800230, gyro_z: -7061602473258970 },
      { timestamp: 4, acc_x: 15423447608947700, acc_y: 13096282958984300, acc_z: 29759926795959400, gyro_x: 8710938692092890, gyro_y: -7654141783714290, gyro_z: -34636059403419400 },
      { timestamp: 4, acc_x: -4692635238170620, acc_y: 4977545261383050, acc_z: 38786067962646400, gyro_x: -10629055500030500, gyro_y: -17366899251937800, gyro_z: 3543018400669090 },
      { timestamp: 4, acc_x: 11494562149047800, acc_y: -1400607943534850, acc_z: -4587290287017820, gyro_x: 22125539779663000, gyro_y: 19089539051055900, gyro_z: -2140471935272210 },
      { timestamp: 4, acc_x: 3375824451444653, acc_y: -5652710437774650, acc_z: -4912901878356930, gyro_x: -30836477279663000, gyro_y: -15619823932647700, gyro_z: 2601675033569330 },
      { timestamp: 4, acc_x: 12445060729980400, acc_y: 1195903778076170, acc_z: 6517016887664790, gyro_x: 1508837193250650, gyro_y: 9731083512306210, gyro_z: -16743816137313800 },
      { timestamp: 5, acc_x: 4355052947998040, acc_y: 6248866558074950, acc_z: 3931279182434080, gyro_x: -23457226157188400, gyro_y: 9468411654233930, gyro_z: 588263213634491 },
      { timestamp: 5, acc_x: 6682217121124260, acc_y: -2310404539108270, acc_z: -1915361404418940, gyro_x: -12137892246246300, gyro_y: -948062837123870, gyro_z: 4092797040939330 },
      { timestamp: 5, acc_x: 12713211059570300, acc_y: 1163581967353820, acc_z: -2774879693984980, gyro_x: 2186897516250610, gyro_y: 26792550086975000, gyro_z: -18973474502563400 },
      { timestamp: 5, acc_x: 5556941986083980, acc_y: 7441178798675530, acc_z: 2985569477081290, gyro_x: -2659096479415890, gyro_y: -1835039138793940, gyro_z: 4075081825256340 },
       { timestamp: 6, acc_x:-23.942017555236800, acc_y:-50.900726318359300	, acc_z:-11.994950771331700	, gyro_x:6.414085030555720	, gyro_y:6.291912198066710, gyro_z:	-5.436700582504270},
        { timestamp:6	, acc_x:3.213976287841790	,  acc_y:2.387019157409660, acc_z:	-2.760514497756950	, gyro_x:12.571606636047300	, gyro_y:	-18.325957655906600	, gyro_z:7470.881938934320},
          { timestamp:6, acc_x:	6.435614109039300, acc_y:	9.062053680419920	, acc_z:463.517427444458	, gyro_x:	20.641136169433500	, gyro_y:	23.774874210357600 ,gyro_z:		-1.463022232055660},
            { timestamp:6,  acc_x:	26.882097244262600,  acc_y:7.637503623962400, acc_z:	19.273324012756300	, gyro_x:	-54.367005825042700,	 gyro_y:-36.651913076639100, gyro_z:		15.754214525222700},
    ]




*/
/*
const datos = [

    {timestamp:0,acc_x:-5.839457988739014,acc_y:6.289567947387695,acc_z:6.603208065032959,gyro_x:4.174653053283691,gyro_y:-2.685363531112671,gyro_z:-1.3469579219818115}
    {timestamp:1,acc_x:-3.4979286193847656,acc_y:4.565742492675781,acc_z:6.390124320983887,gyro_x:-0.3878994286060333,gyro_y:-0.3182607889175415,gyro_z:0.31031954288482666}
    {timestamp:1,acc_x:-1.766920804977417,acc_y:4.9368438720703125,acc_z:9.524134635925293,gyro_x:-0.27550023794174194,gyro_y:-1.2205088138580322,gyro_z:-0.06169738993048668}
    {timestamp:1,acc_x:-1.2521674633026123,acc_y:3.1675288677215576,acc_z:8.317456245422363,gyro_x:0.8148942589759827,gyro_y:0.7220427393913269,gyro_z:0.8442157506942749}
    {timestamp:2,acc_x:1.0127472877502441,acc_y:7.005434036254883,acc_z:6.840234279632568,gyro_x:0.7458664774894714,gyro_y:0.15454891324043274,gyro_z:0.6114761233329773}
    {timestamp:2,acc_x:0.8427590131759644,acc_y:5.789179801940918,acc_z:6.208165168762207,gyro_x:0.2590068578720093,gyro_y:1.0910053253173828,gyro_z:0.6096435189247131}
    {timestamp:2,acc_x:1.0678139925003052,acc_y:7.975085735321045,acc_z:7.2352776527404785,gyro_x:-0.19364428520202637,gyro_y:0.2742784917354584,gyro_z:-0.08918632566928864}
    {timestamp:3,acc_x:0.7493851184844971,acc_y:5.458779811859131,acc_z:7.999027729034424,gyro_x:-0.1466076523065567,gyro_y:-0.11667526513338089,gyro_z:-0.6939429044723511}
    {timestamp:3,acc_x:-0.38067805767059326,acc_y:6.385335922241211,acc_z:8.396465301513672,gyro_x:0.35735616087913513,gyro_y:-0.16310101747512817,gyro_z:-0.4948008358478546}
    {timestamp:3,acc_x:1.137245774269104,acc_y:6.6391215324401855,acc_z:6.169857978820801,gyro_x:1.2198978662490845,gyro_y:1.510058879852295,gyro_z:0.2480112910270691}
    {timestamp:4,acc_x:-0.3016694188117981,acc_y:5.386953830718994,8.224082946777344,CA,0,-0.08491026610136032,0.252287358045578,-0.8307767510414124,28.3799991607666,20.100000381469727,4.859999656677246}
    {4,-0.5506663918495178,5.832275390625,5.954379558563232,CA,0,0.5699372887611389,-1.7519614696502686,-0.4178318381309509,27.899999618530273,21.719999313354492,4.679999828338623}
    {4,12.200851440429688,-4.73573112487793,4.378994941711426,CA,0,-0.9669997096061707,-2.2687535285949707,2.088548183441162,21.65999984741211,24.959999084472656,-2.5799999237060547}
    {5,10.948684692382812,-7.084442615509033,8.379706382751465,CA,0,-4.973053932189941,-2.0812180042266846,1.5161675214767456,19.68000030517578,25.5,-3.5399999618530273}
    {5,9.521739959716797,-9.53849983215332,1.824381709098816,CA,0,1.720807433128357,0.7336491346359253,0.22418753802776337,26.939998626708984,20.459999084472656,12.779999732971191}
    {5,5.118803024291992,-3.090914487838745,1.3646949529647827,CA,0,3.6755762100219727,1.9266690015792847,-2.2424862384796143,25.01999855041504,19.139999389648438,16.260000228881836}
    {6,8.537723541259766,-3.8283286094665527,15.27979564666748,CA,0,-3.6523633003234863,-2.2650883197784424,1.1398745775222778,16.799999237060547,27.53999900817871,12.719999313354492}
    {6,7.103596210479736,-1.678335428237915,3.9025487899780273,CA,0,2.1728477478027344,1.027475357055664,-2.1649065017700195,10.859999656677246,25.68000030517578,17.520000457763672}
    {6,-25.27558708190918,13.00051498413086,13.800178527832031,CA,0,-0.9352346658706665,-1.7049249410629272,-3.2290337085723877,-0.23999999463558197,17.459999084472656,19.920000076293945}
    {6,2.784456491470337,8.051700592041016,3.3925838470458984,CA,0,1.0775662660598755,-0.29138273000717163,-0.6401867866516113,-1.0799999237060547,9.239999771118164,21.239999771118164}
    {7,-3.248931646347046,6.457161903381348,0.009576806798577309,CA,0,-0.2828305959701538,0.4893030524253845,0.0507018156349659,2.0999999046325684,4.440000057220459,23.219999313354492}
    7,-0.15322890877723694,9.981427192687988,4.273650169372559,CA,0,-0.5729916095733643,-0.018936822190880775,-0.033597588539123535,0.7199999690055847,1.9799998998641968,20.81999969482422}
    {7,-2.5091233253479004,6.45476770401001,5.219359874725342,CA,0,-1.2602150440216064,-1.0836749076843262,-0.8643743395805359,0.6599999666213989,0.29999998211860657,19.739999771118164}
    {7,-2.3965959548950195,5.731719017028809,5.228936672210693,CA,0,-2.967583417892456,3.7763688564300537,-0.36102136969566345,3.7799999713897705,-4.440000057220459,17.15999984741211}
    {7,1.0414776802062988,2.0901381969451904,10.60152530670166,CA,0,0.22663100063800812,0.4899139404296875,0.27122417092323303,4.019999980926514,-6.239999771118164,14.519999504089355}
    {8,0.2585737705230713,0.9672574996948242,14.245500564575195,CA,0,0.29626965522766113,-0.04214970022439957,0.17531833052635193,3.8999998569488525,-5.819999694824219,15.119999885559082}
    {8,-1.8555063009262085,1.6759412288665771,13.836091995239258,CA,0,-0.1618792861700058,0.4960225820541382,-0.019547687843441963,4.319999694824219,-4.619999885559082,18.119998931884766}
    {8,-0.21787235140800476,1.7764976024627686,12.164938926696777,CA,0,-0.08979719132184982,-0.09529497474431992,0.2993239760398865,3.119999885559082,-3.6599998474121094,18.059999465942383}
    









  function obtenerCampos() {
    const campos = algoritmo.calcularCaracteristicas(datos);

    return campos;
  }

  const campos = obtenerCampos();*/
  /*
  const inputForPrediction = [
    campos[0],
    campos[1],
    campos[2],
    campos[3],
   // tensor.activityToNumeric('SDL'),
    campos[4],
    campos[5],
    campos[6],
    campos[7],
    campos[8],
  ];
  const inputForPrediction = [
    26.039918537018742,
    7.309796699430188,
    20.378162104442573,
    2.7824758875712914,
    tensor.activityToNumeric('SDL'),
    11.131079696122551,
    3.8913614045630966,
    1.5929268156092316,
    7.086617599915782,
    10.790400250203442,
  ];
  */

  const inputForPrediction = [
    10.418890026987231,
    -2.985834332615485,
    0.573868829996377,
    0.376020183833498,
    -1.3717043537463542,
    0.730220252505188,
    0.6088900269872308,
    0,
    0,
/*
18.05442691384534,
2.056973605549358,
0.217109097305816,
0.2308787122517537,
6.010559669109527,
0.44843089368988,
0.6806311932974212,
0.0327407198000075,
1.977625116104022
*/

];

  try {
  const prediction= await tensor.loadCSVData('../../Train2.csv', trainingOptions, inputForPrediction);
  
  res.send(`Predicción: ${JSON.stringify(prediction.dataSync())}`);
  
  } catch (error) {
    console.error('Error durante la predicción:', error);
  }
  });


const port =process.env.port || 80;
app.listen(port, ()=> console.log(`Escuchando en puerto ${port}...`));

/*
const datos = [
  { timestamp: 1, acc_x: 0.5, acc_y: 0.2, acc_z: 0.9, gyro_x: 0.1, gyro_y: 0.3, gyro_z: 0.2 },
  { timestamp: 2, acc_x: 0.5, acc_y: 0.2, acc_z: 0.9, gyro_x: 0.1, gyro_y: 0.3, gyro_z: 0.2 },
  { timestamp: 3, acc_x: 0.5, acc_y: 0.2, acc_z: 0.9, gyro_x: 0.1, gyro_y: 0.3, gyro_z: 0.2 },
  { timestamp: 4, acc_x: 0.5, acc_y: 0.2, acc_z: 0.9, gyro_x: 0.1, gyro_y: 0.3, gyro_z: 0.2 },
  { timestamp: 5, acc_x: 0.5, acc_y: 0.2, acc_z: 0.9, gyro_x: 0.1, gyro_y: 0.3, gyro_z: 0.2 },
  { timestamp: 6, acc_x: 0.5, acc_y: 0.2, acc_z: 0.9, gyro_x: 0.1, gyro_y: 0.3, gyro_z: 0.2 },
 
];

// Convierte la matriz en una cadena JSON y luego codifícala
const datosJSON = JSON.stringify(datos);
const datosCodificados = encodeURIComponent(datosJSON);

*/